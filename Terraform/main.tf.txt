provider "google" {
  project = var.project_id
  region  = var.region  
}


resource "google_compute_network" "vpc" {
  name                            = var.network_name  
  routing_mode                    = var.routing_mode
  auto_create_subnetworks         = var.auto_create_subnetworks 
  description                     = var.description   
}

resource "google_compute_subnetwork" "subnetwork" {
  name                     = var.subnet_name
  ip_cidr_range            = var.subnet_ip  
  network                  = google_compute_network.vpc.name 
  depends_on    = [google_compute_network.vpc] 
}

resource "google_compute_instance" "servers" {
  count        = 3
  zone         = var.zone
  name         = "bcc-vm-${count.index + 1}"
  machine_type = var.machine_type
  tags          = ["http-server", "https-server", "bcc-allow-ssh"]

  boot_disk {
    initialize_params {
      image = var.image
    }
  }

  network_interface {
    network = google_compute_network.vpc.name
    subnetwork = google_compute_subnetwork.subnetwork.name    
  } 

}

resource "google_compute_instance_group" "bcc-stg-grp" {
  name        = var.instance-grp-name
  description = "bcc instance group"
  zone        = var.zone 
  
    instances = [      
        google_compute_instance.servers[0].id,
        google_compute_instance.servers[1].id,
        google_compute_instance.servers[2].id
    ]  
  
}

resource "google_compute_firewall" "bcc-allow-http" {
  name    = "bcc-allow-http"
  network = google_compute_network.vpc.name
  
  allow {
    protocol = "tcp"
    ports    = ["80"]
  }
  target_tags   = ["allow-http"]
  source_ranges = ["99.225.32.93"]
}

resource "google_compute_firewall" "bcc-allow-https" {
  name    = "bcc-allow-https"
  network = google_compute_network.vpc.name
  
  allow {
    protocol = "tcp"
    ports    = ["443"]
  }
  target_tags   = ["allow-https"]
  source_ranges = ["99.225.32.93"]
}

resource "google_compute_firewall" "bcc-allow-tcp" {
  name    = "bcc-allow-tcp"
  network = google_compute_network.vpc.name
  
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
  target_tags   = ["allow-tcp"]
  source_ranges = ["99.225.32.93"]
}

resource "google_compute_firewall" "bcc-allow-ssh" {
  name    = "bcc-allow-ssh"
  network = google_compute_network.vpc.name
  
  allow {
    protocol = "tcp"
    ports    = ["22"]
  }
  
}

module "load-balancer" {
  source = "../BCC-Terraform/modules/loadbal"
  project_id = var.project_id
  instance-grp-name = google_compute_instance_group.bcc-stg-grp.self_link

}